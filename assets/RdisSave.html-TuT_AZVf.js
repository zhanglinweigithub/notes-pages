import{_ as s,o as a,c as e,a as i}from"./app-Vg0IViah.js";const n="/notes-pages/assets/image-20210725151319695-BegqYiV-.png",d="/notes-pages/assets/image-20210725151543640-D8xmodPU.png",l="/notes-pages/assets/image-20210725151654046-Gqy3wsXu.png",c="/notes-pages/assets/image-20210725151729118-Cj7DxPnJ.png",o="/notes-pages/assets/image-20210725151940515-D66ZmTay.png",r={},p=i(`<h1 id="redis持久化" tabindex="-1"><a class="header-anchor" href="#redis持久化"><span>Redis持久化</span></a></h1><p><code>Redis</code>持久化有两种</p><ol><li><code>RDB</code>：全称<code>Redis Database Backup file</code>（<code>Redis</code>数据备份文件），也被叫做<code>Redis</code>数据快照</li><li><code>AOF</code>：全称<code>Append Only File</code>（追加文件）</li></ol><h2 id="一、rdb" tabindex="-1"><a class="header-anchor" href="#一、rdb"><span>一、RDB</span></a></h2><p><code>RDB</code>全称<code>Redis Database Backup file</code>（<code>Redis</code>数据备份文件），也被叫做<code>Redis</code>数据快照。</p><p>简单来说就是把内存中的所有数据都记录到磁盘中。当<code>Redis</code>实例故障重启后，从磁盘读取快照文件，恢复数据。</p><p>快照文件称为<code>RDB</code>文件，默认是保存在当前运行目录。</p><h3 id="_1、执行时机" tabindex="-1"><a class="header-anchor" href="#_1、执行时机"><span>1、执行时机</span></a></h3><p><code>RDB</code>持久化在四种情况下会执行：</p><ul><li>执行<code>save</code>命令</li><li>执行<code>bgsave</code>命令</li><li><code>Redis</code>停机时：<code>Redis</code>停机时会执行一次<code>save</code>命令，实现<code>RDB</code>持久化。</li><li>触发<code>RDB</code>条件时</li></ul><p><strong>save</strong></p><p>立即执行一次<code>RDB</code></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">redis-cli</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">127.0.0.1:6379&gt;</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> save</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">ok</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p><code>save</code>命令由<code>Redis</code>主进程来执行<code>RDB</code>，会阻塞所有命令，因为<code>Redis</code>是单线程的。</p><p><code>save</code>命令会导致主进程执行<code>RDB</code>，这个过程中其它所有命令都会被阻塞。只有在数据迁移时可能用到。</p></div><p><strong>bgsave</strong></p><p>异步执行<code>RDB</code></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">redis-cli</span></span>
<span class="line"></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">127.0.0.1:6379&gt;</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> bgsave</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">Background</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> saving</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> started</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>开启子进程执行<code>RDB</code>，避免主进程受到影响。</p><p>这个命令执行后会开启独立进程完成<code>RDB</code>，主进程可以持续处理用户请求，不受影响。</p></div><p><strong>触发RDB条件</strong></p><p><code>Redis</code>内部有触发<code>RDB</code>的机制，可以在<code>redis.conf</code>文件中找到，格式如下：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># 900秒内，如果至少有1个key被修改，则执行bgsave, 如果是save &quot;&quot; 则表示禁用RDB</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">save</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 900</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 1</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;"> </span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">save</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 300</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 10</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">save</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 60</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 10000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># save &quot;&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><code>RDB</code>的其它配置也可以在<code>redis.conf</code>文件中设置：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">rdbcompression</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># RDB文件名称</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">dbfilename</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> dump.rdb</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">  </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># 文件保存的路径目录</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">dir</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> ./</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;"> </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h3 id="_2、rdb原理" tabindex="-1"><a class="header-anchor" href="#_2、rdb原理"><span>2、RDB原理</span></a></h3><p><code>bgsave</code>开始时会<code>fork</code>主进程得到子进程，子进程共享主进程的内存数据。完成<code>fork</code>后读取内存数据并写入 <code>RDB</code> 文件。</p><p><code>fork</code>采用的是<code>copy-on-write</code>技术：</p><ul><li>当主进程执行读操作时，访问共享内存；</li><li>当主进程执行写操作时，则会拷贝一份数据，执行写操作。</li></ul><figure><img src="`+n+'" alt="image-20210725151319695" tabindex="0" loading="lazy"><figcaption>image-20210725151319695</figcaption></figure><h2 id="二、aof" tabindex="-1"><a class="header-anchor" href="#二、aof"><span>二、AOF</span></a></h2><p><code>AOF</code>全称为<code>Append Only File</code>（追加文件）。</p><p><code>Redis</code>处理的每一个写命令都会记录在<code>AOF</code>文件，可以看做是命令日志文件。</p><figure><img src="'+d+`" alt="image-20210725151543640" tabindex="0" loading="lazy"><figcaption>image-20210725151543640</figcaption></figure><h3 id="_1、配置" tabindex="-1"><a class="header-anchor" href="#_1、配置"><span>1、配置</span></a></h3><p><code>AOF</code>默认是关闭的，需要修改<code>redis.conf</code>配置文件来开启<code>AOF</code></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># 是否开启AOF功能，默认是no</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">appendonly</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> yes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># AOF文件的名称</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">appendfilename</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> &quot;appendonly.aof&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AOF</code>的命令记录的频率也可以通过<code>redis.conf</code>文件来配</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># 表示每执行一次写命令，立即记录到AOF文件</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">appendfsync</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> always</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">appendfsync</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> everysec</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;"> </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">appendfsync</span><span style="color:#CE9178;--shiki-dark:#CE9178;"> no</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+l+'" alt="image-20210725151654046" tabindex="0" loading="lazy"><figcaption>image-20210725151654046</figcaption></figure><h3 id="_2、aof文件重写" tabindex="-1"><a class="header-anchor" href="#_2、aof文件重写"><span>2、AOF文件重写</span></a></h3><p>因为是记录命令，<code>AOF</code>文件会比<code>RDB</code>文件大的多。而且<code>AOF</code>会记录对同一个<code>key</code>的多次写操作，但只有最后一次写操作才有意义。</p><p>通过执行<code>bgrewriteaof</code>命令，可以让<code>AOF</code>文件执行重写功能，用最少的命令达到相同效果。</p><figure><img src="'+c+`" alt="image-20210725151729118" tabindex="0" loading="lazy"><figcaption>image-20210725151729118</figcaption></figure><p><code>Redis</code>也会在触发阈值时自动去重写<code>AOF</code>文件。阈值也可以在<code>redis.conf</code>中配置：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># AOF文件比上次文件 增长超过多少百分比则触发重写</span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">auto-aof-rewrite-percentage</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 100</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;--shiki-dark:#6A9955;"># AOF文件体积最小多大以上才触发重写 </span></span>
<span class="line"><span style="color:#DCDCAA;--shiki-dark:#DCDCAA;">auto-aof-rewrite-min-size</span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;"> 64</span><span style="color:#CE9178;--shiki-dark:#CE9178;">mb</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;"> </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="三、rdb与aof对比" tabindex="-1"><a class="header-anchor" href="#三、rdb与aof对比"><span>三、RDB与AOF对比</span></a></h2><p><code>RDB</code>和<code>AOF</code>各有自己的优缺点，在实际开发中往往会<strong>结合</strong>两者来使用。</p><figure><img src="`+o+'" alt="image-20210725151940515" tabindex="0" loading="lazy"><figcaption>image-20210725151940515</figcaption></figure>',46),t=[p];function k(D,h){return a(),e("div",null,t)}const A=s(r,[["render",k],["__file","RdisSave.html.vue"]]),u=JSON.parse('{"path":"/Use/Java/Redis/RdisSave.html","title":"Redis持久化","lang":"zh-CN","frontmatter":{"category":"使用篇"},"headers":[{"level":2,"title":"一、RDB","slug":"一、rdb","link":"#一、rdb","children":[{"level":3,"title":"1、执行时机","slug":"_1、执行时机","link":"#_1、执行时机","children":[]},{"level":3,"title":"2、RDB原理","slug":"_2、rdb原理","link":"#_2、rdb原理","children":[]}]},{"level":2,"title":"二、AOF","slug":"二、aof","link":"#二、aof","children":[{"level":3,"title":"1、配置","slug":"_1、配置","link":"#_1、配置","children":[]},{"level":3,"title":"2、AOF文件重写","slug":"_2、aof文件重写","link":"#_2、aof文件重写","children":[]}]},{"level":2,"title":"三、RDB与AOF对比","slug":"三、rdb与aof对比","link":"#三、rdb与aof对比","children":[]}],"git":{"createdTime":1708330205000,"updatedTime":1708873062000,"contributors":[{"name":"zhanglinwei","email":"3498729975@qq.com","commits":2}]},"readingTime":{"minutes":3.29,"words":986},"filePathRelative":"Use/Java/Redis/RdisSave.md","localizedDate":"2024年2月19日"}');export{A as comp,u as data};
