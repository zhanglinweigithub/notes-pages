import{_ as s,o as a,c as n,a as i}from"./app-Vg0IViah.js";const l="/notes-pages/assets/image-20210723171948228-B5Yp5fz0.png",e="/notes-pages/assets/image-20210723172917636-Bo26ofTG.png",D={},o=i(`<h1 id="聚合-dsl" tabindex="-1"><a class="header-anchor" href="#聚合-dsl"><span>聚合-DSL</span></a></h1><p>聚合常见的有三类：</p><ul><li><strong>桶（Bucket）</strong> 聚合：用来对文档做分组，相当于 <code>MySql</code>的<code>group by</code></li><li><code>TermAggregation</code>：按照文档字段值分组</li><li><code>Date Histogram</code>：按照日期阶梯分组，例如一周为一组，或者一月为一组</li><li><strong>度量（Metric）</strong> 聚合：用以计算一些值，比如：最大值、最小值、平均值等</li><li><code>Avg</code>：求平均值</li><li><code>Max</code>：求最大值</li><li><code>Min</code>：求最小值</li><li><code>Stats</code>：同时求<code>max</code>、<code>min</code>、<code>avg</code>、<code>sum</code>等</li><li><strong>管道（pipeline）</strong> 聚合：其它聚合的结果为基础做聚合</li></ul><div class="hint-container warning"><p class="hint-container-title">注意</p><p>参加聚合的字段必须是<code>keyword</code>、日期、数值、布尔类型</p></div><h2 id="一、bucket聚合" tabindex="-1"><a class="header-anchor" href="#一、bucket聚合"><span>一、Bucket聚合</span></a></h2><h3 id="查询" tabindex="-1"><a class="header-anchor" href="#查询"><span>查询</span></a></h3><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">GET /hotel/_search</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;query&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 查询条件</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">        &quot;range&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">            &quot;price&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;lte&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">200</span><span style="color:#6A9955;--shiki-dark:#6A9955;"> // 只对200元以下的文档聚合</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">            }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">    },</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;size&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">0</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">, </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 设置size为0，结果中不包含文档，只包含聚合结果</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;aggs&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 定义聚合</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">        &quot;brandAgg&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">//给聚合起个名字,自定义</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">            &quot;terms&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 聚合的类型，按照品牌值聚合，所以选择term</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;field&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#CE9178;--shiki-dark:#CE9178;">&quot;brand&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">, </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 参与聚合的字段</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;size&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">20</span><span style="color:#6A9955;--shiki-dark:#6A9955;"> // 希望获取的聚合结果数量</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">            }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果如下：</p><figure><img src="`+l+`" alt="image-20210723171948228" tabindex="0" loading="lazy"><figcaption>image-20210723171948228</figcaption></figure><h3 id="聚合结果排序" tabindex="-1"><a class="header-anchor" href="#聚合结果排序"><span>聚合结果排序</span></a></h3><p>默认情况下，<code>Bucket</code>聚合会统计<code>Bucket</code>内的文档数量，记为<code>doc_count</code>，并且按照<code>doc_count</code>降序排序。</p><p>可以指定<code>order</code>属性，自定义聚合的排序方式</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">GET /hotel/_search</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;query&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 查询条件</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">        &quot;range&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">            &quot;price&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;lte&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">200</span><span style="color:#6A9955;--shiki-dark:#6A9955;"> // 只对200元以下的文档聚合</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">            }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">    },</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;size&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">0</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;aggs&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">        &quot;brandAgg&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">            &quot;terms&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;field&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#CE9178;--shiki-dark:#CE9178;">&quot;brand&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;order&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                    &quot;_count&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#CE9178;--shiki-dark:#CE9178;">&quot;asc&quot;</span><span style="color:#6A9955;--shiki-dark:#6A9955;"> // 按照_count升序排列</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">                },</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;size&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">20</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">            }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="二、metric聚合" tabindex="-1"><a class="header-anchor" href="#二、metric聚合"><span>二、Metric聚合</span></a></h2><p>对聚合后桶内的结果做运算</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><pre class="shiki shiki-themes dark-plus dark-plus" style="background-color:#1E1E1E;--shiki-dark-bg:#1E1E1E;color:#D4D4D4;--shiki-dark:#D4D4D4;" tabindex="0"><code><span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">GET /hotel/_search</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;size&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">0</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">    &quot;aggs&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">        &quot;brandAgg&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">            &quot;terms&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;field&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#CE9178;--shiki-dark:#CE9178;">&quot;brand&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;size&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#B5CEA8;--shiki-dark:#B5CEA8;">20</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;order&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: {</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                    &quot;scoreAgg.avg&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#F44747;--shiki-dark:#F44747;">desc</span><span style="color:#6A9955;--shiki-dark:#6A9955;"> // 按照每个桶的平均分做排序</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">                }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">            },</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">            &quot;aggs&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 是brandAgg聚合的子聚合，也就是分组后对每组分别计算</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                &quot;scoreAgg&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 聚合名称自定义</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                    &quot;stats&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: { </span><span style="color:#6A9955;--shiki-dark:#6A9955;">// 聚合类型，这里stats可以计算min、max、avg等</span></span>
<span class="line"><span style="color:#9CDCFE;--shiki-dark:#9CDCFE;">                        &quot;field&quot;</span><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">: </span><span style="color:#CE9178;--shiki-dark:#CE9178;">&quot;score&quot;</span><span style="color:#6A9955;--shiki-dark:#6A9955;"> // 聚合字段，这里是score</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">                    }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">                }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">            }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">        }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;--shiki-dark:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+e+'" alt="image-20210723172917636" tabindex="0" loading="lazy"><figcaption>image-20210723172917636</figcaption></figure>',17),r=[o];function p(c,d){return a(),n("div",null,r)}const k=s(D,[["render",p],["__file","Aggregation-DSL.html.vue"]]),h=JSON.parse('{"path":"/Use/Java/ElasticSearch/Aggregation-DSL.html","title":"聚合-DSL","lang":"zh-CN","frontmatter":{"order":12,"category":"使用篇"},"headers":[{"level":2,"title":"一、Bucket聚合","slug":"一、bucket聚合","link":"#一、bucket聚合","children":[{"level":3,"title":"查询","slug":"查询","link":"#查询","children":[]},{"level":3,"title":"聚合结果排序","slug":"聚合结果排序","link":"#聚合结果排序","children":[]}]},{"level":2,"title":"二、Metric聚合","slug":"二、metric聚合","link":"#二、metric聚合","children":[]}],"git":{"createdTime":1708330205000,"updatedTime":1708873062000,"contributors":[{"name":"zhanglinwei","email":"3498729975@qq.com","commits":2}]},"readingTime":{"minutes":1.62,"words":485},"filePathRelative":"Use/Java/ElasticSearch/Aggregation-DSL.md","localizedDate":"2024年2月19日"}');export{k as comp,h as data};
